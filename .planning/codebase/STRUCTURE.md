# Codebase Structure

**Analysis Date:** 2026-02-16

## Directory Layout

```
introspection/
├── .planning/              # GSD planning docs (generated)
├── .github/                # GitHub workflows
├── .vscode/                # VSCode config
├── pocwork/                # Work-in-progress / experimental
│   ├── *.rpy               # Sandbox files
│   └── GAME_ARCHITECTURE.md
├── game/                   # Main game directory
│   ├── 0_definitions.rpy   # Core data definitions
│   ├── core/               # Engine systems
│   ├── data/               # Content (characters, encounters)
│   ├── story/              # Narrative content
│   ├── screens/            # UI screens
│   ├── saves/              # Save files
│   ├── cache/              # Ren'Py cache
│   └── assets/             # Images, audio
├── README.md               # Project documentation
└── TODO.md                 # Development tasks
```

## Directory Purposes

### `game/core/`
- Purpose: Core game systems and engine
- Contains: State management, belief system, NPC system
- Key files:
  - `0_config.rpy` - Constants and config
  - `1_game_state.rpy` - GameState class
  - `2_belief_system.rpy` - Belief mechanics
  - `3_npc_system.rpy` - NPCState class
  - `encounter_router.rpy` - Encounter selection
  - `reality_shifts.rpy` - Visual effects
  - `introspection_system.rpy` - Introspection UI

### `game/data/`
- Purpose: Game content and data
- Contains: Characters, encounters, NPC data
- Key files:
  - `npc_data.rpy` - NPC initialization
- Subdirectories:
  - `characters/` - Individual NPC definitions
  - `encounters/` - Encounter scenarios

### `game/story/`
- Purpose: Narrative content
- Contains: Chapters, therapy sessions
- Key files:
  - `script.rpy` - Entry point
  - `chapter_00.rpy`, `chapter_01.rpy` - Story chapters
- Subdirectories:
  - `therapy/` - Therapy session content

### `game/screens/`
- Purpose: UI and screens
- Contains: Visual interface elements
- Key files:
  - `main_screens.rpy` - Main menu, etc.
  - `debug_hud.rpy` - Debug overlay

### `game/saves/`
- Purpose: Persisted game state
- Contains: Save files, persistent data
- Generated by Ren'Py at runtime

### `pocwork/`
- Purpose: Proof-of-concept and experimental code
- Contains: Sandbox files, tests
- Not loaded in main game

## Key File Locations

**Entry Points:**
- `game/story/script.rpy` - Main `label start:`
- `game/0_definitions.rpy` - Loads first (alphabetically)

**Core Systems:**
- `game/core/1_game_state.rpy` - Player state
- `game/core/3_npc_system.rpy` - NPC state

**Content:**
- Characters: `game/data/characters/*.rpy`
- Encounters: `game/data/encounters/*.rpy`

## Naming Conventions

**Files:**
- `.rpy` - Ren'Py script files
- `.rpyc` - Compiled bytecode (generated)
- Prefix numbers for load order: `0_`, `1_`, `2_`, `3_`

**Labels:**
- `label start:` - Entry point
- `label chapter_XX:` - Chapter labels
- `label check_belief_alignment:` - Action handlers

**Classes:**
- `GameState` - Player state manager
- `NPCState` - NPC state manager
- `EncounterRouter` - Encounter selector

## Where to Add New Code

**New Story Chapter:**
- File: `game/story/chapter_XX.rpy`
- Register in: `game/story/script.rpy` → `main_game_flow`

**New NPC:**
- Definition: `game/data/characters/npc_name.rpy`
- Initialization: `game/data/npc_data.rpy`
- Add beliefs/emotions in `game/0_definitions.rpy`

**New Encounter:**
- File: `game/data/encounters/encounter_name.rpy`
- Register in: Add to encounter vault via `EncounterRouter`

**New Core System:**
- File: `game/core/system_name.rpy`
- Ensure load order with numeric prefix

**New UI Screen:**
- File: `game/screens/screen_name.rpy`
- Follows Ren'Py screen language

## Special Directories

### `game/cache/`
- Purpose: Ren'Py compiled bytecode cache
- Generated: Yes
- Committed: No (in .gitignore)

### `game/saves/`
- Purpose: Player save files
- Generated: Yes
- Committed: No

### `.comfyui/`
- Purpose: ComfyUI workflow configs
- Generated: Yes
- Contains: JSON workflow files

---

*Structure analysis: 2026-02-16*
