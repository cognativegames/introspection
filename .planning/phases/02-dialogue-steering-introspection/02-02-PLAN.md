---
phase: 02-dialogue-steering-introspection
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - game/core/introspection_system.rpy
  - game/story/therapy/sessions.rpy
  - game/core/1_game_state.rpy
  - game/story/script.rpy
autonomous: true
requirements:
  - INTRO-01
  - INTRO-02
  - INTRO-03
  - INTRO-04
  - INTRO-05

must_haves:
  truths:
    - "Introspection offered after 2+ negative interpretations"
    - "Shows both beliefs AND emotions to player"
    - "Resolving belief instantly shifts related emotions"
    - "Day-by-day therapy with groundhog day until milestone"
    - "Dr. Chen provides reflection after choices"
  artifacts:
    - path: "game/core/introspection_system.rpy"
      provides: "Introspection UI and conflict resolution flow"
    - path: "game/story/therapy/sessions.rpy"
      provides: "Day-by-day therapy session structure"
  key_links:
    - from: "game/core/introspection_system.rpy"
      to: "game/core/1_game_state.rpy"
      via: "Belief resolution updates emotions immediately"
    - from: "game/story/therapy/sessions.rpy"
      to: "game/core/encounter_router.rpy"
      via: "Dr. Chen offers encounters from vault"
---

<objective>
Implement introspection triggers, conflict visualization, belief examination flow, and day-by-day therapy sessions with Dr. Chen.
</objective>

<context>
@game/core/introspection_system.rpy - Existing introspection UI
@game/story/therapy/sessions.rpy - Therapy session structure
@.planning/phases/02-dialogue-steering-introspection/02-CONTEXT.md
@02-01-PLAN.md - Encounter router (prerequisite)

**KEY DECISIONS:**
- Introspection offered after 2+ consecutive negative interpretations
- Shows BOTH beliefs AND emotions - "What must I believe is true for me to feel this way?"
- Resolving negative belief → assign positive → emotions shift IMMEDIATELY
- Decline introspection = "living in denial" → enhanced negative emotions (loneliness, emptiness, detachment)
- Groundhog day: replay same day until milestone achieved
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement introspection trigger system</name>
  <files>game/core/introspection_system.rpy</files>
  <action>
    Add to introspection system:
    
    ```
    label offer_introspection(game_state):
        # INTRO-01: Trigger after 2+ negative interpretations
        if not game_state.should_trigger_introspection():
            return
        
        # Show introspection offer
        scene dr_chen_office
        show dr_chen
        
        dr_chen "I notice you've been interpreting things quite negatively lately."
        dr_chen "Would you like to explore what's happening internally?"
        
        # Display current emotional state
        call show_emotion_dashboard(game_state)
        
        menu:
            "Yes, I want to understand":
                jump introspection_explore
            
            "I'm not ready to examine this":
                # Living in denial - enhanced negative emotions (INTRO-01)
                $ game_state.adjust_emotions({
                    "loneliness": 2,
                    "emptiness": 1,
                    "detachment": 2
                })
                dr_chen "That's your choice. But these feelings won't resolve themselves."
                return
    
    label show_emotion_dashboard(game_state):
        # Show both beliefs AND emotions (INTRO-01)
        "Current emotional state:"
        $ negative_emotions = {k: v for k, v in game_state.emotions.items() if v > 5}
        for emotion, value in sorted(negative_emotions.items(), key=lambda x: -x[1]):
            "- [emotion]: [value]/10"
        
        "Active beliefs:"
        $ active_beliefs = {k: v for k, v in game_state.beliefs.items() if v > 0}
        for belief_id, intensity in sorted(active_beliefs.items(), key=lambda x: -x[1]):
            if belief_id in beliefs:
                "- [beliefs[belief_id]['label']]: [intensity]"
        return
    ```
  </action>
  <verify>
    Introspection triggers after 2+ negative interpretations, shows beliefs AND emotions
  </verify>
  <done>Introspection trigger system implemented</done>
</task>

<task type="auto">
  <name>Task 2: Build conflict visualization (INTRO-02)</name>
  <files>game/core/introspection_system.rpy</files>
  <action>
    Add conflict detection and visualization:
    
    ```
    def get_belief_conflicts(game_state):
        """Detect contradictory beliefs and calculate severity"""
        conflicts = []
        
        # Define contradictory pairs
        contradiction_pairs = [
            ("i_am_worthless", "i_am_enough"),
            ("i_am_unlovable", "i_am_worthy_of_connection"),
            ("i_cannot_succeed", "i_am_capable"),
            ("people_will_leave", "i_am_safe_in_relationships"),
            ("i_am_a_fraud", "i_am_authentic")
        ]
        
        for neg, pos in contradiction_pairs:
            neg_intensity = game_state.beliefs.get(neg, 0)
            pos_intensity = game_state.beliefs.get(pos, 0)
            
            if neg_intensity > 0 and pos_intensity > 0:
                severity = (neg_intensity + pos_intensity) / 2
                conflicts.append({
                    "negative": neg,
                    "positive": pos,
                    "severity": severity,
                    "emotional_impact": severity * 2  # Maps to anxiety/overwhelm
                })
        
        return sorted(conflicts, key=lambda x: -x["severity"])
    
    label visualize_conflicts(game_state):
        $ conflicts = get_belief_conflicts(game_state)
        
        if not conflicts:
            dr_chen "I don't see any conflicting beliefs. That's good progress."
            return
        
        "Belief conflicts detected:"
        
        for i, conflict in enumerate(conflicts):
            $ neg_label = beliefs[conflict["negative"]]["label"]
            $ pos_label = beliefs[conflict["positive"]]["label"]
            $ severity_bar = "!" * int(conflict["severity"])
            
            "[i+1]. [neg_label] vs [pos_label] [severity_bar]"
            "- Emotional impact: [conflict['emotional_impact']]/10"
        
        return conflicts
    ```
  </action>
  <verify>
    Conflicts displayed with severity, shows both beliefs
  </verify>
  <done>Conflict visualization implemented</done>
</task>

<task type="auto">
  <name>Task 3: Belief examination flow (INTRO-03)</name>
  <files>game/core/introspection_system.rpy</files>
  <action>
    Add belief examination and resolution:
    
    ```
    label introspection_explore:
        # INTRO-03: Let player choose which belief to examine
        call visualize_conflicts(game_state)
        
        dr_chen "Which belief would you like to examine?"
        
        menu:
            "Examine my negative belief":
                jump examine_negative_belief
            
            "Examine my positive belief":
                jump examine_positive_belief
            
            "Neither - show me a synthesis":
                jump offer_synthesis
    
    label examine_negative_belief:
        # Show negative belief and its emotional consequences
        $ active_negatives = [b for b, i in game_state.beliefs.items() if i > 0 and beliefs.get(b, {}).get('type') == 'negative']
        
        if not active_negatives:
            dr_chen "You don't have any active negative beliefs to examine."
            return
        
        menu:
            "Which negative belief?":
                for belief_id in active_negatives:
                    "[beliefs[belief_id]['label']]":
                        $ selected_belief = belief_id
        
        # Show what emotions this belief creates
        $ related_emotions = beliefs[selected_belief].get("related_emotions", {})
        "Holding '[beliefs[selected_belief]['label']]' creates:"
        for emotion, weight in related_emotions.items():
            "- [emotion]: +[weight * game_state.beliefs[selected_belief]]"
        
        menu:
            "Release this belief":
                # INTRO-03: Examine and resolve
                $ game_state.resolve_belief(selected_belief)
                jump belief_resolved
            
            "Keep this belief":
                dr_chen "That's okay. The belief is still serving you in some way."
                return
    
    label examine_positive_belief:
        # Similar flow for positive beliefs
        $ active_positives = [b for b, i in game_state.beliefs.items() if i > 0 and beliefs.get(b, {}).get('type') == 'positive']
        
        if not active_positives:
            dr_chen "You don't have active positive beliefs yet. Let's work on that."
            return
        
        menu:
            "Which positive belief?":
                for belief_id in active_positives:
                    "[beliefs[belief_id]['label']]":
                        $ selected_belief = belief_id
        
        "Believing '[beliefs[belief_id]['label']]' creates:"
        $ related_emotions = beliefs[belief_id].get("related_emotions", {})
        for emotion, weight in related_emotions.items():
            "- [emotion]: +[weight]"
        
        dr_chen "This belief is serving you well."
        return
    ```
  </action>
  <verify>
    Player can examine beliefs, choose to release or keep
  </verify>
  <done>Belief examination flow implemented</done>
</task>

<task type="auto">
  <name>Task 4: Belief synthesis (INTRO-04)</name>
  <files>game/core/introspection_system.rpy</files>
  <action>
    Add synthesis options for belief conflicts:
    
    ```
    label offer_synthesis:
        dr_chen "Sometimes neither belief feels completely true. There's another option."
        dr_chen "Let's find a way to hold both truths."
        
        # INTRO-04: Synthesis options
        menu:
            "I'm learning and growing":
                # Both negative and positive can coexist as "becoming"
                $ game_state.update_belief("i_am_worthless", 2)  # Lower to examined
                $ game_state.update_belief("i_am_enough", 3)
                $ game_state.adjust_emotions({"hope": 2, "clarity": 1})
                jump synthesis_complete
            
            "I can be both flawed and worthy":
                # Integrate both - imperfection doesn't negate worth
                $ game_state.update_belief("i_am_worthless", 2)
                $ game_state.update_belief("i_am_enough", 4)
                $ game_state.adjust_emotions({"self_compassion": 2, "belonging": 1})
                jump synthesis_complete
            
            "My past doesn't define my future":
                # Temporal shift - past negative doesn't predict future
                $ game_state.update_belief("i_am_a_fraud", 2)
                $ game_state.update_belief("i_am_capable", 3)
                $ game_state.adjust_emotions({"hope": 2, "connection": 1})
                jump synthesis_complete
    
    label synthesis_complete:
        # INTRO-04: Belief synthesis applies positive emotions
        dr_chen "That's a healthy integration. You're not denying your experiences - you're transcending them."
        "Feelings shift as new understanding emerges."
        return
    ```
  </action>
  <verify>
    Synthesis options offered when neither belief feels true
  </verify>
  <done>Belief synthesis implemented</done>
</task>

<task type="auto">
  <name>Task 5: Immediate belief-emotion coupling</name>
  <files>game/core/1_game_state.rpy</files>
  <action>
    Add instant emotion shift on belief resolution:
    
    ```
    def resolve_belief(self, belief_id, assign_positive_belief=None):
        """
        Resolve a negative belief and optionally assign a positive one.
        IMMEDIATELY shifts related emotions.
        """
        # Set to RESOLVED state
        self.beliefs[belief_id] = BELIEF_RESOLVED  # 4
        
        # INTRO-05: Immediate emotion shift
        if assign_positive_belief:
            self.beliefs[assign_positive_belief] = BELIEF_ACTIVE  # 3
            
            # Get positive belief's emotional benefits
            positive_benefits = beliefs[assign_positive_belief].get("related_emotions", {})
            self.adjust_emotions(positive_benefits)
        
        # Also reduce negative emotion impact
        negative_impacts = beliefs[belief_id].get("related_emotions", {})
        reduction = {}
        for emotion, weight in negative_impacts.items():
            reduction[emotion] = -weight
        self.adjust_emotions(reduction)
        
        # Reset negative interpretation counter
        self.consecutive_negatives = 0
        
        return True
    
    def update_belief(self, belief_id, intensity):
        """Update belief intensity - also updates related emotions"""
        old_intensity = self.beliefs.get(belief_id, 0)
        self.beliefs[belief_id] = intensity
        
        # Immediate emotion adjustment on belief change
        if belief_id in beliefs:
            belief_data = beliefs[belief_id]
            emotion_impacts = belief_data.get("related_emotions", {})
            
            delta = {}
            for emotion, weight in emotion_impacts.items():
                change = (intensity - old_intensity) * weight
                if change != 0:
                    delta[emotion] = change
            
            if delta:
                self.adjust_emotions(delta)
    ```
  </action>
  <verify>
    Resolving belief instantly shifts emotions - no delay
  </verify>
  <done>Immediate belief-emotion coupling implemented</done>
</task>

<task type="auto">
  <name>Task 6: Day-by-day therapy sessions with groundhog day</name>
  <files>game/story/therapy/sessions.rpy</files>
  <action>
    Create therapy session structure:
    
    ```
    define THERAPY_DAY_COUNT = 1
    define THERAPY_MILESTONE_PROGRESS = 3  # Days until milestone
    
    label start_therapy_day:
        # Groundhog day model: replay until milestone achieved
        $ day = THERAPY_DAY_COUNT
        "Day [day]: Session with Dr. Chen"
        
        # Check milestone progress
        $ milestone_progress = count_resolved_beliefs()
        
        if milestone_progress >= THERAPY_MILESTONE_PROGRESS:
            jump therapy_milestone_reached
        
        # Standard session flow
        call dr_chen_greeting
        call offer_encounter(game_state)
        call dr_chen_reflection
        call check_day_completion
        
        return
    
    label dr_chen_greeting:
        show dr_chen
        if THERAPY_DAY_COUNT == 1:
            dr_chen "Welcome to our therapy sessions. We'll work together to understand your inner world."
        else:
            $ days_since_start = THERAPY_DAY_COUNT
            dr_chen "Good to see you again. We've had [days_since_start] sessions now."
        return
    
    label dr_chen_reflection:
        # INTRO-05: Dr. Chen provides reflection after choices
        dr_chen "Let me share what I observe..."
        
        $ dominant_emotion = game_state.get_dominant_emotion()
        "Dr. Chen notes your current dominant emotion: [dominant_emotion]"
        
        $ recent_beliefs = game_state.get_recent_belief_changes()
        if recent_beliefs:
            "Recent belief shifts: [recent_beliefs]"
        
        if game_state.should_trigger_introspection():
            dr_chen "I think it's time we explore what's happening internally."
            call offer_introspection(game_state)
        
        return
    
    label check_day_completion:
        # Check if player achieved daily goal
        $ day_goal_met = check_daily_goal()
        
        if not day_goal_met:
            # Groundhog day - repeat
            "You haven't made progress today. The day repeats..."
            $ THERAPY_DAY_COUNT += 1
            jump start_therapy_day
        
        # Progress made - advance day
        $ THERAPY_DAY_COUNT += 1
        "Good progress today. Let's continue tomorrow."
        return
    
    label therapy_milestone_reached:
        # Major milestone achieved
        scene positive_transformation
        dr_chen "You've made significant progress. This marks an important transition."
        "Achievement unlocked: Core Beliefs Transformed"
        return
    
    def count_resolved_beliefs():
        """Count beliefs in RESOLVED state"""
        return sum(1 for b in game_state.beliefs.values() if b == BELIEF_RESOLVED)
    
    def check_daily_goal():
        """Check if daily therapeutic goal was achieved"""
        # Goal: at least one positive interpretation OR one belief resolved
        return (game_state.consecutive_negatives == 0 or 
                count_resolved_beliefs() > 0)
    ```
  </action>
  <verify>
    Day-by-day therapy with groundhog day until milestone
  </verify>
  <done>Day-by-day therapy sessions implemented</done>
</task>

<task type="auto">
  <name>Task 7: Dr. Chen integration in main flow</name>
  <files>game/story/script.rpy</files>
  <action>
    Connect therapy sessions to main game flow:
    
    ```
    # In main game flow, after chapter or milestone
    label transition_to_therapy:
        scene dr_chen_office
        show dr_chen
        
        dr_chen "Before we continue, let's process what just happened."
        
        # Trigger any needed introspection
        if game_state.should_trigger_introspection():
            call offer_introspection(game_state)
        
        # Offer encounter
        call offer_encounter(game_state)
        
        # Dr. Chen reflection
        call dr_chen_reflection
        
        # Determine if ready to continue story
        menu:
            "I'm ready to continue":
                return
            
            "I need more time here":
                jump start_therapy_day
    ```
  </action>
  <verify>
    Therapy integrates with story flow via Dr. Chen
  </verify>
  <done>Dr. Chen integration complete</done>
</task>

</tasks>

<verification>
- INTRO-01: Triggers after 2+ negative interpretations, shows beliefs AND emotions
- INTRO-02: Conflicts visualized with severity and emotional impact
- INTRO-03: Player can examine and resolve beliefs
- INTRO-04: Synthesis options when neither belief feels true
- INTRO-05: Dr. Chen therapy sessions connected to belief system with day-by-day groundhog model
</verification>

<success_criteria>
1. INTRO-01: Introspection offered after 2+ negative interpretations, shows both beliefs and emotions
2. INTRO-02: Conflict visualization shows severity and emotional impact
3. INTRO-03: Belief examination flow lets player choose which to keep/examine
4. INTRO-04: Synthesis options for transcending conflicts
5. INTRO-05: Day-by-day therapy sessions with groundhog day, Dr. Chen reflection
</success_criteria>

<output>
After completion, create `.planning/phases/02-dialogue-steering-introspection/02-02-SUMMARY.md`
</output>
