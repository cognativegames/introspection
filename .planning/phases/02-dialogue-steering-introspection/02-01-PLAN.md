---
phase: 02-dialogue-steering-introspection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - game/core/encounter_router.rpy
  - game/data/encounters/encounter_vault.rpy
  - game/data/encounters/therapy_encounters.rpy
  - game/0_definitions.rpy
autonomous: true
requirements:
  - ENCO-01
  - ENCO-02
  - ENCO-03
  - ENCO-04
  - ENCO-05

must_haves:
  truths:
    - "Encounters are therapist-offered, player cannot access directly"
    - "Router uses hybrid of story progression + character state"
    - "Encounters map to belief tiers - player progresses through tiers"
    - "Vault starts focused on 3 clusters: self-worth, relationships, capability"
  artifacts:
    - path: "game/core/encounter_router.rpy"
      provides: "EncounterRouter class with select_encounter() method"
    - path: "game/data/encounters/encounter_vault.rpy"
      provides: "ENCOUNTER_VAULT with clustered encounters"
    - path: "game/data/encounters/therapy_encounters.rpy"
      provides: "Encounter scenarios offered by Dr. Chen"
  key_links:
    - from: "game/core/encounter_router.rpy"
      to: "game/core/1_game_state.rpy"
      via: "GameState beliefs and emotions for routing decisions"
    - from: "game/core/encounter_router.rpy"
      to: "game/data/encounters/encounter_vault.rpy"
      via: "ENCOUNTER_VAULT data access"
---

<objective>
Build encounter routing system with therapist-offered encounters, hybrid selection logic, and dynamic vault adapting to player beliefs.
</objective>

<context>
@game/core/encounter_router.rpy - Existing router with basic selection
@game/0_definitions.rpy - Belief and emotion definitions
@.planning/phases/02-dialogue-steering-introspection/02-CONTEXT.md

**KEY DECISIONS:**
- Player CANNOT access encounters directly - therapist (Dr. Chen) offers them
- Router uses hybrid: story progression + character state (emotions, beliefs)
- Encounter selection based on player's negative beliefs and emotional state
- Vault starts with 3 clusters (self-worth, relationships, capability), 3+ scenarios each
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ENCOUNTER_VAULT data structure</name>
  <files>game/data/encounters/encounter_vault.rpy</files>
  <action>
    Create new file game/data/encounters/encounter_vault.rpy with:
    
    ```
    define ENCOUNTER_VAULT = {
        "self-worth": {
            "tier": 1,
            "beliefs_targeted": ["i_am_worthless", "i_am_inadequate", "i_am_unlovable"],
            "encounters": [
                {
                    "id": "sw_001",
                    "title": "The Mirror",
                    "description": "You catch your reflection in a store window.",
                    "interpretations": [
                        {"type": "negative", "belief": "i_am_worthless", "delta": {"shame": 2, "inadequacy": 2}},
                        {"type": "neutral", "belief": None, "delta": {"clarity": 1}},
                        {"type": "positive", "belief": "i_am_enough", "delta": {"compassion": 2, "hope": 1}}
                    ]
                },
                # ... 2 more self-worth scenarios
            ]
        },
        "relationships": {
            "tier": 1,
            "beliefs_targeted": ["people_will_leave", "i_am_not_enough", "trust_leads_to_pain"],
            "encounters": [
                {
                    "id": "rel_001",
                    "title": "The Phone Call",
                    "description": "A friend cancels plans at the last minute.",
                    "interpretations": [
                        {"type": "negative", "belief": "people_will_leave", "delta": {"loneliness": 2, "fear": 1}},
                        {"type": "neutral", "belief": None, "delta": {}},
                        {"type": "positive", "belief": "i_am_worthy_of_connection", "delta": {"connection": 1, "belonging": 1}}
                    ]
                },
                # ... 2 more relationship scenarios
            ]
        },
        "capability": {
            "tier": 1,
            "beliefs_targeted": ["i_cannot_succeed", "i_am_a_fraud", "others_are_better"],
            "encounters": [
                {
                    "id": "cap_001",
                    "title": "The Presentation",
                    "description": "You're asked to present your work to the team.",
                    "interpretations": [
                        {"type": "negative", "belief": "i_cannot_succeed", "delta": {"anxiety": 2, "vulnerability": 2}},
                        {"type": "neutral", "belief": None, "delta": {"clarity": 1}},
                        {"type": "positive", "belief": "i_am_capable", "delta": {"hope": 2, "connection": 1}}
                    ]
                },
                # ... 2 more capability scenarios
            ]
        }
    }
    
    define ENCOUNTER_BELIEF_TIERS = {
        1: ["self-worth", "relationships", "capability"],
        2: ["self-acceptance", "intimacy", "authenticity"],
        3: ["all_clusters"]
    }
    ```
  </action>
  <verify>
    ENCOUNTER_VAULT has 3 clusters with 3+ encounters each
  </verify>
  <done>ENCOUNTER_VAULT structure created</done>
</task>

<task type="auto">
  <name>Task 2: Add negative interpretation tracking to GameState</name>
  <files>game/core/1_game_state.rpy</files>
  <action>
    Add to GameState class after __init__:
    
    ```
    # Track consecutive negative interpretations for introspection trigger
    self.consecutive_negatives = 0
    self.negative_interpretation_count = 0  # Total in current session
    ```
    
    Add method:
    ```
    def record_interpretation(self, interpretation_type):
        """Record player interpretation for introspection tracking"""
        if interpretation_type == "negative":
            self.consecutive_negatives += 1
            self.negative_interpretation_count += 1
        else:
            self.consecutive_negatives = 0
    
    def should_trigger_introspection(self):
        """Check if player qualifies for introspection offer"""
        return self.consecutive_negatives >= 2 or self.negative_interpretation_count >= 4
    ```
  </action>
  <verify>
    GameState has record_interpretation() and should_trigger_introspection()
  </verify>
  <done>Negative interpretation tracking added to GameState</done>
</task>

<task type="auto">
  <name>Task 3: Build hybrid EncounterRouter class</name>
  <files>game/core/encounter_router.rpy</files>
  <action>
    Update EncounterRouter to support therapist-offered encounters:
    
    ```
    class EncounterRouter:
        def __init__(self):
            self.current_encounter = None
            self.available_tiers = [1]  # Start at tier 1
        
        def select_encounter(self, game_state, story_progression=0):
            """
            Select encounter using hybrid of story + character state.
            
            Args:
                game_state: GameState instance with beliefs/emotions
                story_progression: 0-10 story progress indicator
            
            Returns:
                Encounter dict from vault
            """
            # Step 1: Identify target clusters based on active negative beliefs
            target_clusters = self._identify_target_clusters(game_state)
            
            # Step 2: Check emotional state for anxiety routing (ENCO-02)
            if game_state.emotions.get("anxiety", 0) > 7:
                # High anxiety - prioritize calming encounters (self-worth, self-acceptance)
                target_clusters = ["self-worth"] + target_clusters
            
            # Step 3: Select from appropriate tier
            tier = self._determine_accessible_tier(game_state, story_progression)
            
            # Step 4: Filter vault by clusters and tier
            candidates = self._get_candidates(target_clusters, tier)
            
            # Step 5: Avoid recent repeats
            candidates = self._filter_recent(candidates, game_state)
            
            # Step 6: Return selected or None if no candidates
            if candidates:
                return candidates[0]
            return None
        
        def _identify_target_clusters(self, game_state):
            """Map active negative beliefs to encounter clusters"""
            cluster_mapping = {
                "i_am_worthless": "self-worth",
                "i_am_inadequate": "self-worth",
                "i_am_unlovable": "self-worth",
                "people_will_leave": "relationships",
                "i_am_not_enough": "relationships",
                "trust_leads_to_pain": "relationships",
                "i_cannot_succeed": "capability",
                "i_am_a_fraud": "capability",
                "others_are_better": "capability"
            }
            
            targets = []
            for belief_id, intensity in game_state.beliefs.items():
                if intensity > 0 and belief_id in cluster_mapping:
                    cluster = cluster_mapping[belief_id]
                    if cluster not in targets:
                        targets.append(cluster)
            
            return targets if targets else ["self-worth"]  # Default
        
        def _determine_accessible_tier(self, game_state, story_progression):
            """Determine which tier player can access"""
            # Progress tier based on resolved negative beliefs
            resolved_count = sum(1 for b in game_state.beliefs.values() if b == 4)
            tier = min(1 + resolved_count, 3)
            return tier
        
        def _get_candidates(self, clusters, tier):
            """Get encounter candidates from vault"""
            candidates = []
            for cluster in clusters:
                if cluster in ENCOUNTER_VAULT:
                    for enc in ENCOUNTER_VAULT[cluster]["encounters"]:
                        candidates.append(enc)
            return candidates
        
        def _filter_recent(self, candidates, game_state):
            """Remove recently completed encounters"""
            recent = getattr(game_state, 'recent_encounters', [])
            return [c for c in candidates if c['id'] not in recent]
        
        def mark_encounter_completed(self, game_state, encounter_id):
            """Record completed encounter"""
            if not hasattr(game_state, 'recent_encounters'):
                game_state.recent_encounters = []
            game_state.recent_encounters.append(encounter_id)
            # Keep only last 10
            game_state.recent_encounters = game_state.recent_encounters[-10:]
    ```
  </action>
  <verify>
    EncounterRouter.select_encounter() uses hybrid story + character state
  </verify>
  <done>Hybrid EncounterRouter implemented</done>
</task>

<task type="auto">
  <name>Task 4: Create therapist-offered encounter flow</name>
  <files>game/data/encounters/therapy_encounters.rpy</files>
  <action>
    Create Dr. Chen encounter offering system:
    
    ```
    define dr_chen = Character("Dr. Chen", color="#8B4513", who_alt="Dr. Chen")
    
    label offer_encounter(game_state):
        $ router = EncounterRouter()
        $ encounter = router.select_encounter(game_state)
        
        if encounter is None:
            dr_chen "I don't have anything specific to work on today. Let's just talk."
            return
        
        # Show therapist offer (player cannot refuse without consequence)
        dr_chen "I'd like to try something with you today."
        show encounter preview (title=encounter["title"], description=encounter["description"])
        
        menu:
            "Accept the encounter":
                jump run_encounter
            
            "I'm not ready for this":
                # Living in denial - enhanced negative emotions
                $ game_state.adjust_emotions({
                    "loneliness": 2,
                    "emptiness": 1,
                    "detachment": 1
                })
                dr_chen "That's okay. Take your time. But avoiding these feelings doesn't make them go away."
                return
    
    label run_encounter(encounter):
        # Present the encounter scenario with interpretations
        scene imagination
        show encounter visual (based on game_state.beliefs)
        
        player encounter description
        
        menu:
            "How do you interpret this?"
            
            for interpretation in encounter["interpretations"]:
                "[interpretation.type]":
                    $ game_state.record_interpretation(interpretation["type"])
                    if interpretation["belief"]:
                        $ game_state.update_belief(interpretation["belief"], 3)  # Activate
                    if interpretation["delta"]:
                        $ game_state.adjust_emotions(interpretation["delta"])
        
        # Check if introspection should trigger
        if game_state.should_trigger_introspection():
            jump offer_introspection
        
        dr_chen "Let's continue processing this."
        return
    ```
  </action>
  <verify>
    Therapy encounters offered by Dr. Chen, not player-accessible
  </verify>
  <done>Therapist-offered encounter flow created</done>
</task>

<task type="auto">
  <name>Task 5: Add dynamic visual adaptation based on beliefs</name>
  <files>game/data/encounters/therapy_encounters.rpy</files>
  <action>
    Add belief-based visual rendering to encounter scenes:
    
    ```
    define ENCOUNTER_VISUAL_STATES = {
        "default": "imagination_neutral",
        "i_am_worthless": "imagination_dimmed",
        "people_will_leave": "imagination_empty",
        "i_cannot_succeed": "imagination_foggy",
        "i_am_enough": "imagination_bright",
        "i_am_worthy_of_connection": "imagination_warm"
    }
    
    def get_encounter_visual(beliefs):
        """Determine visual state based on active beliefs"""
        # Check for strongest negative belief
        strongest_negative = None
        max_intensity = 0
        
        for belief_id, intensity in beliefs.items():
            if intensity > max_intensity:
                max_intensity = intensity
                strongest_negative = belief_id
        
        if strongest_negative and strongest_negative in ENCOUNTER_VISUAL_STATES:
            return ENCOUNTER_VISUAL_STATES[strongest_negative]
        
        # Check for positive beliefs
        for belief_id, intensity in beliefs.items():
            if intensity > 2 and belief_id in ["i_am_enough", "i_am_worthy_of_connection", "i_am_capable"]:
                return ENCOUNTER_VISUAL_STATES[belief_id]
        
        return ENCOUNTER_VISUAL_STATES["default"]
    ```
  </action>
  <verify>
    Encounter visuals adapt based on player belief state
  </verify>
  <done>Dynamic visual adaptation implemented</done>
</task>

</tasks>

<verification>
- ENCOUNTER_VAULT has 3 clusters (self-worth, relationships, capability) with 3+ encounters each
- EncounterRouter.select_encounter() uses hybrid story + character state selection
- Player cannot access encounters directly - only through Dr. Chen offer
- Negative interpretation tracking enables introspection trigger
- Visuals adapt based on belief state
</verification>

<success_criteria>
1. ENCO-01: Encounter router integrates with GameState for selection
2. ENCO-02: High anxiety (>7) triggers calming/self-worth encounters
3. ENCO-03: Active negative beliefs trigger targeted encounters
4. ENCO-04: Each encounter offers positive/negative/neutral interpretations affecting beliefs
5. ENCO-05: Encounter vault has 3+ scenarios per active cluster
</success_criteria>

<output>
After completion, create `.planning/phases/02-dialogue-steering-introspection/02-01-SUMMARY.md`
</output>
