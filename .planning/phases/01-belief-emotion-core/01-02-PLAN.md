---
phase: 01-belief-emotion-core
plan: 02
type: execute
wave: 2
depends_on:
  - 01-01
files_modified:
  - game/screens/debug_hud.rpy
  - game/core/2_belief_system.rpy
  - game/core/reality_shifts.rpy
autonomous: true
requirements:
  - BELIEF-01
  - BELIEF-02
  - BELIEF-03
  - BELIEF-04
  - BELIEF-05
  - REAL-01
  - REAL-02
  - REAL-03
  - REAL-04

must_haves:
  truths:
    - "Self-awareness UI toggle appears at 70% threshold"
    - "Player actions activate beliefs (not just dialogue choices)"
    - "Reality shifts trigger from belief conflicts"
    - "Debug HUD shows emotions at 0-10 scale"
  artifacts:
    - path: "game/screens/debug_hud.rpy"
      provides: "self_awareness_toggle screen, updated 0-10 scale"
    - path: "game/core/2_belief_system.rpy"
      provides: "activate_from_action() method, trigger_belief_from_action()"
    - path: "game/core/reality_shifts.rpy"
      provides: "Belief conflict to reality shift connection"
  key_links:
    - from: "game/screens/debug_hud.rpy"
      to: "game/core/1_game_state.rpy"
      via: "is_self_awareness_unlocked() method call"
    - from: "game/core/2_belief_system.rpy"
      to: "game/core/1_game_state.rpy"
      via: "activate_from_action() on game_state"
---

<objective>
Add self-awareness UI toggle at 70% threshold and fix belief activation from player actions.
</objective>

<context>
@game/screens/debug_hud.rpy - Existing HUD screens
@game/core/2_belief_system.rpy - Belief system with check_belief_alignment
@game/core/reality_shifts.rpy - Reality shift triggers
@.planning/phases/01-belief-emotion-core/01-CONTEXT.md

**Key decisions from CONTEXT:**
- Self-awareness UI: Toggle with static icon in corner, appears only when self-awareness >70%
- Belief activation: Through both dialogue choices AND player actions
- Negative beliefs ARE the conflict - when contradictory beliefs active, emotions spike
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update debug HUD for 0-10 emotion scale</name>
  <files>game/screens/debug_hud.rpy</files>
  <action>
    Update debug_hud.rpy to use 0-10 scale throughout:
    
    1. Change emotion bar ranges from 100 to 10:
       - Line ~91: `bar value value range 100` → `bar value value range 10`
    
    2. Update threshold checks:
       - Line ~86: `if value >= 15:` → `if value >= 2:` (15% of 10 = 1.5, round to 2)
       - Line ~283: `if value >= 20:` → `if value >= 2:`
       - Line ~308-315: Update get_emotion_color thresholds:
         - `value >= 70` → `value >= 7`
         - `value >= 50` → `value >= 5`
         - `value >= 30` → `value >= 3`
    
    3. Update any other 0-100 references in emotion-related code
  </action>
  <verify>
    All emotion bars use range 10, threshold checks updated
  </verify>
  <done>Debug HUD uses 0-10 emotion scale</done>
</task>

<task type="auto">
  <name>Task 2: Add self-awareness UI toggle at 70% threshold</name>
  <files>game/screens/debug_hud.rpy</files>
  <action>
    Add self-awareness UI to debug_hud.rpy:
    
    1. Add toggle variable:
       - After line ~9: `default show_awareness_ui = False`
    
    2. Create new screen "self_awareness_toggle":
       ```
       screen self_awareness_toggle():
           """
           Static toggle icon that appears when self-awareness > 70%
           Clicking opens the awareness UI
           """
           python:
               show_toggle = game_state and game_state.is_self_awareness_unlocked()
           
           if show_toggle:
               button:
                   xalign 0.98
                   yalign 0.15
                   background Frame("gui/awareness_icon.png", 10, 10)
                   padding (10, 10)
                   action ToggleVariable("show_awareness_ui")
                   
                   # Pulse animation when newly unlocked
                   if 70 <= game_state.get_self_awareness_percentage() < 75:
                       add "pulse_animation" 
       ```
    
    3. Update introspection_hud to check self-awareness:
       - Line ~33: Change condition to include self-awareness check:
         `should_show = show_debug_hud or (game_state and game_state.is_self_awareness_unlocked())`
    
    4. Add self_awareness_display screen showing emotions/beliefs when unlocked:
       - Show current self-awareness percentage
       - Show dominant emotions
       - Show active negative beliefs
       - Show conflict indicator
    
    5. Add to overlay screens:
       - Line ~426: Add self_awareness_toggle to overlay
  </action>
  <verify>
    Toggle icon appears only when self_awareness >= 70%
  </verify>
  <done>Self-awareness UI toggle works at 70% threshold</done>
</task>

<task type="auto">
  <name>Task 3: Fix belief activation from player actions</name>
  <files>game/core/2_belief_system.rpy</files>
  <action>
    Fix belief activation to work from player actions, not just dialogue:
    
    1. Update check_belief_alignment label (line 42-87):
       - Change from using old `player_state["core_beliefs"]` dict to use `game_state.beliefs`
       - Use BELIEF_INTENSITY constants instead of magic numbers (7, 4)
       
    2. Create new function for action-based belief activation:
       ```
       def activate_belief_from_action(action_belief_id, intensity=BELIEF_INTENSITY_ACTIVE):
           """
           Called when player takes an action that relates to a belief.
           Activates the belief and triggers conflict check.
           """
           game_state.activate_belief(action_belief_id, intensity)
           
           # Check for conflicts after belief activation
           conflicts = game_state.detect_belief_conflicts()
           if conflicts:
               # Apply emotional consequences
               game_state.apply_conflict_consequences()
           
           return conflicts
       ```
    
    3. Add function to GameState class:
       Add method after activate_belief():
       ```
       def activate_from_action(self, belief_id, intensity=BELIEF_INTENSITY_ACTIVE):
           """Activate belief from player action, check for conflicts"""
           self.activate_belief(belief_id, intensity)
           conflicts = self.detect_belief_conflicts()
           if conflicts:
               self.apply_conflict_consequences()
           return conflicts
       ```
    
    4. Add convenience function at module level for easy calling from dialogue/actions:
       ```
       def trigger_belief_from_action(action_type, action_details):
           """
           Map player actions to belief activations.
           action_type: string like "avoid_connection", "pursue_achievement"
           """
           belief_map = {
               "avoid_connection": "self.is-unworthy",
               "pursue_achievement": "self.must-earn-love",
               "trust_stranger": "others.are-friendly",
               "withdraw_from_people": "others.are-cruel",
               # Add more mappings as needed
           }
           
           if action_type in belief_map:
               return game_state.activate_from_action(belief_map[action_type])
           return None
       ```
  </action>
  <verify>
    Player actions can trigger belief activation via activate_from_action()
  </verify>
  <done>Belief activation works from both dialogue choices and player actions</done>
</task>

<task type="auto">
<name>Task 4: Connect reality shifts to belief system</name>
<files>game/core/reality_shifts.rpy</files>
<action>
    Ensure reality shifts are properly connected to belief conflicts:
    
    1. Update trigger_reality_shift to use game_state:
       - Change `reality_stability` references to use game_state methods
       - Use game_state.beliefs for alignment checks
    
    2. Add belief-based shift triggers:
       After a belief conflict is detected and consequences applied:
       ```
       # In apply_conflict_consequences or after it
       def check_and_trigger_shift_from_conflict():
           conflicts = game_state.detect_belief_conflicts()
           if not conflicts:
               return
           
           # Calculate shift severity from conflict
           max_severity = max(c[2] for c in conflicts)
           
           if max_severity >= BELIEF_INTENSITY_CORE:
               # Severe conflict - trigger reality shift
               if game_state.is_self_awareness_unlocked():
                   # Player is aware enough to handle it
                   shift_level = "moderate"
               else:
                   # Player unaware - more jarring
                   shift_level = "severe"
               call trigger_reality_shift(shift_level, "belief_conflict")
       ```
    
    3. Ensure harmony state triggers when beliefs align:
       In check_belief_alignment, when is_aligned is True and alignment_score is high:
       - Already triggers "harmony" shift at reality_stability >= 9
       - Update to use game_state self-awareness
  </action>
  <verify>
    Reality shifts trigger from belief conflicts with proper severity
  </verify>
  <done>Reality shifts connected to belief conflict system</done>
</task>

</tasks>

<verification>
- Debug HUD uses 0-10 emotion scale
- Self-awareness toggle appears at 70% threshold
- Player actions can activate beliefs via activate_from_action()
- Reality shifts trigger from belief conflicts
</verification>

<success_criteria>
1. Self-awareness UI toggle visible only when >= 70%
2. Player actions trigger belief activation (not just dialogue)
3. Reality shifts trigger from belief conflicts
4. Debug HUD shows emotions at 0-10 scale
5. All 13 requirements (BELIEF-01 to BELIEF-05, REAL-01 to REAL-04) addressed
</success_criteria>

<output>
After completion, create `.planning/phases/01-belief-emotion-core/01-02-SUMMARY.md`
</output>
